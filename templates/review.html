<!DOCTYPE html>
<html>
<head>
    <title>Review Data</title>
    <style>
        table { border-collapse: collapse; width: 100%; }
        td, th { border: 1px solid #ddd; padding: 8px; }
        tr:nth-child(even) { background-color: #f2f2f2; }
        .progress-container { margin: 20px 0; display: none; }
        .progress-bar { height: 20px; background: #4CAF50; animation: progress 2s infinite; }
        @keyframes progress { 0% { width: 0; } 50% { width: 50%; } 100% { width: 100%; } }
        .return-address { margin: 20px 0; padding: 15px; border: 1px solid #ddd; }
        .return-address input { margin: 5px; }
    </style>
</head>
<body>
    <h1>Review CSV Data</h1>
    
    <div class="return-address">
        <h3>Return Address</h3>
        <input type="text" name="return_name" value="{{ return_address.name }}" required>
        <input type="text" name="return_street1" value="{{ return_address.street1 }}" required>
        <input type="text" name="return_street2" value="{{ return_address.street2 }}">
        <input type="text" name="return_city" value="{{ return_address.city }}" required>
        <input type="text" name="return_state" value="{{ return_address.state }}" required style="width: 50px">
        <input type="text" name="return_zip" value="{{ return_address.zip }}" required>
    </div>

    <form id="dataForm" onsubmit="return submitForm(event)">
        <table>
            <thead>
                <tr>
                    {% if rows %}
                        {% for key in rows[0].keys() %}
                            <th>{{ key }}</th>
                        {% endfor %}
                    {% endif %}
                </tr>
            </thead>
            <tbody>
                {% if rows %}
                    {% for row in rows %}
                        <tr>
                            {% for key, value in row.items() %}
                                <td><input type="text" name="{{ key }}[]" value="{{ value }}"></td>
                            {% endfor %}
                        </tr>
                    {% endfor %}
                {% else %}
                    <tr>
                        <td colspan="100%" style="text-align: center;">No data found</td>
                    </tr>
                {% endif %}
            </tbody>
        </table>
        <div class="progress-container" id="progressContainer">
            <div class="progress-bar"></div>
            <p>Generating labels... This may take a moment</p>
        </div>
        <button type="submit">Generate Labels</button>
    </form>

    <script>
        async function submitForm(e) {
    e.preventDefault();
    const progressContainer = document.getElementById('progressContainer');
    const submitButton = document.querySelector('button[type="submit"]');
    
    progressContainer.style.display = 'block';
    submitButton.disabled = true;

    try {
        const formData = [];
        const inputs = document.querySelectorAll('input[name]');
        const columnCount = document.querySelectorAll('th').length;
        const rowCount = document.querySelectorAll('tbody tr').length;

        // Process return address
        const returnAddress = {
            name: document.querySelector('input[name="return_name"]').value,
            street1: document.querySelector('input[name="return_street1"]').value,
            street2: document.querySelector('input[name="return_street2"]').value,
            city: document.querySelector('input[name="return_city"]').value,
            state: document.querySelector('input[name="return_state"]').value,
            zip: document.querySelector('input[name="return_zip"]').value,
            country: 'US'
        };

        // Process data rows
        for (let i = 0; i < rowCount; i++) {
            const row = {};
            for (let j = 0; j < columnCount; j++) {
                const input = inputs[(i * columnCount) + j];
                const fieldName = input.name.replace('[]', '');
                row[fieldName] = input.value;
            }
            formData.push(row);
        }

        const response = await fetch(`/generate/{{ file_id }}`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                form_data: formData,
                return_address: returnAddress
            })
        });

        if (!response.ok) {
            const error = await response.json();
            throw error.error || 'Unknown error occurred';
        }

        const blob = await response.blob();
        const url = window.URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = 'labels.pdf';
        a.click();
    } catch (error) {
        alert('Error: ' + error);
    } finally {
        progressContainer.style.display = 'none';
        submitButton.disabled = false;
    }
}
    </script>
</body>
</html>